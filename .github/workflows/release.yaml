name: Release - Bump and Release v2 üöÄ
on: [workflow_dispatch]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

jobs:
  release:
    name: Create and publish release
    runs-on: ubuntu-latest

    steps:
      - name: ‚§µÔ∏è„ÄÄCheckout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 1
          ref: ${{ github.ref }}

      - name: üóë„ÄÄDelete drafts
        uses: hugo19941994/delete-draft-releases@v2.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üî¢ Calculate next semantic version
        id: semver
        uses: ietf-tools/semver-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: main

      - name: üßæ Display version info
        run: |
          echo "Current version: ${{ steps.semver.outputs.current }}"
          echo "Next version: ${{ steps.semver.outputs.next }}"

      - name: üîÑ„ÄÄUpdate version in 'VERSION' and 'manifest.json' and push changes
        env:
          tag_name: ${{ steps.semver.outputs.next }}
          GITHUB_REPO: ${{ github.event.repository.name }}
        run: |
          echo "** Manifest before replace **"
          cat custom_components/$GITHUB_REPO/manifest.json
          sed -i 's/"version": ".*"/"version": "'$tag_name'"/g' custom_components/$GITHUB_REPO/manifest.json
          echo "** Manifest after replace **"
          cat custom_components/$GITHUB_REPO/manifest.json
          echo $tag_name > VERSION

      - name: "‚úèÔ∏è„ÄÄGenerate release changelog"
        uses: janheinrichmerker/action-github-changelog-generator@v2.4
        with:
          token: ${{ secrets.GH_PAT }}
          output: CHANGELOG.md
          issues: true
          issuesWoLabels: true
          pullRequests: true
          prWoLabels: true
          unreleased: false
          addSections: '{"documentation":{"prefix":"**Documentation:**","labels":["documentation"]}}'

      - name: üßæ Display version info
        run: |
          pwd
          find /home
          cat CHANGELOG.md

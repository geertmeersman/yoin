---
name: Release

on:
  release:
    types:
      - published

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - name: ⤵️ Check out code from GitHub
        uses: actions/checkout@v5.0.0

      - name: 🔢 Adjust version number in 'VERSION' and 'manifest.json'
        env:
          GITHUB_REPO: ${{ github.event.repository.name }}
        run: |
          echo "** Manifest before replace **"
          cat custom_components/$GITHUB_REPO/manifest.json
          sed -i 's/"version": ".*"/"version": "'${{ github.event.release.tag_name }}'"/g' custom_components/$GITHUB_REPO/manifest.json
          echo "** Manifest after replace **"
          cat custom_components/$GITHUB_REPO/manifest.json
          echo ${{ github.event.release.tag_name }} > VERSION

      - name: "✏️　Generate release changelog"
        uses: heinrichreimer/github-changelog-generator-action@v2.4
        with:
          token: ${{ secrets.GH_PAT }}
          issues: true
          issuesWoLabels: true
          pullRequests: true
          prWoLabels: true
          unreleased: false
          addSections: '{"documentation":{"prefix":"**Documentation:**","labels":["documentation"]}}'

      - name: ✅　Commit release notes and bump version
        uses: EndBug/add-and-commit@v9
        with:
          message: "docs: Commit release notes and bump version ${{ steps.release_drafter.outputs.tag_name }}"


      - name: 📦 Created zipped release package
        shell: bash
        run: |
          cd "${{ github.workspace }}/custom_components/${{ github.event.repository.name }}"
          zip ${{ github.event.repository.name }}.zip -r ./

      - name: 🔏 Sign release package
        uses: sigstore/gh-action-sigstore-python@v3.0.1
        with:
          inputs: ${{ github.workspace }}/custom_components/${{ github.event.repository.name }}/${{ github.event.repository.name }}.zip

      - name: ⬆️ Upload zip to release
        uses: softprops/action-gh-release@v2.4.1
        with:
          files: ${{ github.workspace }}/custom_components/${{ github.event.repository.name }}/${{ github.event.repository.name }}.zip
